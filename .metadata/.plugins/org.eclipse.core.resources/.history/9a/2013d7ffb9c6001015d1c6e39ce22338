package com.service;

import java.util.ArrayList;
import java.util.List;
import com.model.User;

// 业务逻辑层（封装所有核心业务，与Servlet解耦）
public class UserService {
    // 静态列表：存储所有注册用户（模拟数据库，服务器重启后数据丢失，符合实验要求）
    private static List<User> userList = new ArrayList<>();

    // 1. 注册业务：返回true=成功，false=失败
    public boolean register(User user) {
        // 验证1：用户名是否已存在
        if (checkUsernameExists(user.getUsername())) {
            return false;
        }
        // 验证2：密码格式是否符合要求
        if (!validatePasswordFormat(user.getPassword())) {
            return false;
        }
        // 验证通过：添加用户到列表
        userList.add(user);
        return true;
    }

    // 2. 登录业务：返回User对象=成功，null=失败
    public User login(String username, String password) {
        // 遍历用户列表，匹配用户名和密码
        for (User user : userList) {
            if (user.getUsername().equals(username) && user.getPassword().equals(password)) {
                return user; // 登录成功，返回用户信息
            }
        }
        return null; // 用户名不存在或密码错误
    }

    // 3. 更改用户名业务：返回true=成功，false=失败
    public boolean updateUsername(String oldUsername, String newUsername) {
        // 验证1：新用户名是否已存在
        if (checkUsernameExists(newUsername)) {
            return false;
        }
        // 验证2：新用户名格式是否符合要求（同密码格式）
        if (!validatePasswordFormat(newUsername)) {
            return false;
        }
        // 查找旧用户名对应的用户，更新用户名
        for (User user : userList) {
            if (user.getUsername().equals(oldUsername)) {
                user.setUsername(newUsername);
                return true;
            }
        }
        return false; // 未找到旧用户名（理论上不会触发，因登录后才允许修改）
    }

    // 4. 更改密码业务：返回true=成功，false=失败
    public boolean updatePassword(String username, String oldPwd, String newPwd) {
        // 验证1：旧密码是否正确
        User user = getuserByUsername(username);
        if (user == null || !user.getPassword().equals(oldPwd)) {
            return false;
        }
        // 验证2：新密码格式是否符合要求
        if (!validatePasswordFormat(newPwd)) {
            return false;
        }
        // 验证通过：更新密码
        user.setPassword(newPwd);
        return true;
    }

    // 辅助方法1：检查用户名是否已存在
    public boolean checkUsernameExists(String username) {
        for (User user : userList) {
            if (user.getUsername().equals(username)) {
                return true;
            }
        }
        return false;
    }

    // 辅助方法2：验证密码/用户名格式（符合实验要求：≥8字符，≥2字母、≥2数字、1大写1小写）
    public boolean validatePasswordFormat(String str) {
        // 正则表达式：满足所有格式要求
        String regex = "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d.*\\d)(?=.*[a-zA-Z].*[a-zA-Z]).{8,}$";
        return str.matches(regex);
    }

    // 辅助方法3：通过用户名获取用户对象
    public User getuserByUsername(String username) {
        for (User user : userList) {
            if (user.getUsername().equals(username)) {
                return user;
            }
        }
        return null;
    }
}